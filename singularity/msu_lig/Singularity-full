Bootstrap: docker
From: nvidia/cuda:9.2-runtime

%help
Singularity base container for python apps with conda

%files
    env.yml /opt/environment.yml

%environment
    PATH=${PATH}:/opt/conda/envs/myenv/bin

%post
    apt-get update -y
    apt-get install -y software-properties-common
    apt-add-repository -y ppa:graphics-drivers/ppa
    apt-get install -y wget git build-essential
    rm -rf /var/lib/apt/lists/*
    
    rm -rf /var/lib/apt/lists/*
    wget "http://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh" -O setup.sh 
    bash setup.sh -p /opt/conda -b 
    rm -rf setup.sh
    update-alternatives --install /usr/local/bin/conda conda /opt/conda/bin/conda 1
    
    conda update -y conda
    conda env create -f /opt/environment.yml
    conda clean -afy
    . /opt/conda/etc/profile.d/conda.sh
    conda activate myenv

%runscript 
    exec "$@"

%apprun print_version
    python --version

%apphelp python_version
    Print python version and exit

%apprun python_shell
    python

%apphelp python_shell
    Launch python shell

%apprun python_script
    python "$@"

%apphelp python_script
    Run a python script
